<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>发布新帖子 - 社区论坛</title>
  <!-- 引入Layui CSS -->
  <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all">
  <!-- 引入Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <style>
    body {
      background-color: #f2f3f5;
      padding-top: 15px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 15px;
    }
    .post-card {
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }
    .layui-form-item {
      margin-bottom: 20px;
    }
    .layui-form-label {
      width: 80px;
      padding: 9px 0;
    }
    .layui-input-block {
      margin-left: 110px;
    }
    .tag-item {
      display: inline-block;
      background-color: #f2f2f2;
      border-radius: 4px;
      padding: 2px 8px;
      margin-right: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tag-item:hover {
      background-color: #e6e6e6;
    }
    .tag-item .close {
      margin-left: 5px;
      color: #999;
    }
    .tag-item .close:hover {
      color: #333;
    }
    .tags-input {
      width: 100%;
      border: 1px solid #e6e6e6;
      border-radius: 4px;
      padding: 8px 10px;
      min-height: 38px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .tags-input input {
      border: none;
      outline: none;
      flex-grow: 1;
      min-width: 80px;
      height: 24px;
      padding: 0;
    }
    .layui-btn-group {
      float: right;
    }
    .editor-toolbar {
      border-bottom: 1px solid #e6e6e6;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    .editor-toolbar button {
      background: none;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 14px;
      border-radius: 2px;
    }
    .editor-toolbar button:hover {
      background-color: #f2f2f2;
    }
    .word-count {
      text-align: right;
      color: #999;
      font-size: 12px;
      margin-top: 5px;
    }
    .form-footer {
      border-top: 1px solid #e6e6e6;
      padding-top: 15px;
      margin-top: 15px;
    }
    .category-tip {
      color: #999;
      font-size: 12px;
      margin-top: 5px;
    }
    @media screen and (max-width: 768px) {
      .layui-form-label {
        width: 60px;
      }
      .layui-input-block {
        margin-left: 90px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 页面标题 -->
    <div class="layui-row">
      <div class="layui-col-md12">
        <h2 style="margin-bottom: 20px;"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 发布新帖子</h2>
      </div>
    </div>
    
    <!-- 帖子发布卡片 -->
    <div class="post-card">
      <form class="layui-form" action="" lay-filter="postForm">
        <!-- 标题输入 -->
        <div class="layui-form-item">
          <label class="layui-form-label" for="title">标题</label>
          <div class="layui-input-block">
            <input type="text" id="title" name="title" placeholder="请输入帖子标题（至少5个字符）" 
                   autocomplete="off" class="layui-input" lay-verify="required|titleLength">
          </div>
        </div>
        
        <!-- 分类选择 -->
        <div class="layui-form-item">
          <label class="layui-form-label">分类</label>
          <div class="layui-input-block">
            <select name="category" lay-verify="required">
              <option value="">请选择分类</option>
              <option value="technology">技术讨论</option>
              <option value="share">经验分享</option>
              <option value="question">问题求助</option>
              <option value="news">行业动态</option>
              <option value="offtopic">灌水闲聊</option>
            </select>
            <p class="category-tip">选择合适的分类有助于更多人看到你的帖子</p>
          </div>
        </div>
        
        <!-- 内容编辑器 -->
        <div class="layui-form-item">
          <label class="layui-form-label">内容</label>
          <div class="layui-input-block">
            <!-- 编辑器工具栏 -->
            <div class="editor-toolbar">
              <button type="button" data-command="bold"><i class="fa fa-bold"></i></button>
              <button type="button" data-command="italic"><i class="fa fa-italic"></i></button>
              <button type="button" data-command="underline"><i class="fa fa-underline"></i></button>
              <span style="display: inline-block; width: 1px; height: 16px; background: #e6e6e6; margin: 0 8px;"></span>
              <button type="button" data-command="insertUnorderedList"><i class="fa fa-list-ul"></i></button>
              <button type="button" data-command="insertOrderedList"><i class="fa fa-list-ol"></i></button>
              <span style="display: inline-block; width: 1px; height: 16px; background: #e6e6e6; margin: 0 8px;"></span>
              <button type="button" id="insertImage"><i class="fa fa-image"></i></button>
              <button type="button" id="insertLink"><i class="fa fa-link"></i></button>
            </div>
            
            <!-- 编辑区域 -->
            <div id="contentEditor" contenteditable="true" 
                 style="min-height: 300px; border: 1px solid #e6e6e6; border-radius: 4px; padding: 10px; outline: none;"
                 lay-verify="required|contentLength"></div>
            
            <!-- 字数统计 -->
            <div class="word-count">
              <span id="wordCount">0</span> 字 (至少10个字)
            </div>
          </div>
        </div>
        
        <!-- 标签 -->
        <div class="layui-form-item">
          <label class="layui-form-label">标签</label>
          <div class="layui-input-block">
            <div class="tags-input" id="tagsContainer">
              <input type="text" id="tagInput" placeholder="输入标签，按回车添加">
            </div>
            <p class="category-tip">最多添加5个标签，每个标签不超过8个字符</p>
          </div>
        </div>
        
        <!-- 隐私设置 -->
        <div class="layui-form-item">
          <label class="layui-form-label">可见范围</label>
          <div class="layui-input-block">
            <input type="radio" name="visibility" value="public" title="公开" checked>
            <input type="radio" name="visibility" value="registered" title="仅注册用户">
            <input type="radio" name="visibility" value="private" title="仅自己可见">
          </div>
        </div>
        
        <!-- 提交按钮 -->
        <div class="form-footer">
          <div class="layui-btn-group">
            <button type="button" class="layui-btn layui-btn-primary" id="previewBtn">预览</button>
            <button type="button" class="layui-btn layui-btn-primary" id="saveDraftBtn">保存草稿</button>
            <button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="postSubmit">发布帖子</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 图片上传弹窗 -->
  <div class="layui-layer layui-layer-page" id="imageUploadLayer" style="display: none; width: 500px;">
    <div class="layui-layer-title">上传图片</div>
    <div class="layui-layer-content" style="padding: 20px;">
      <form class="layui-form" lay-filter="imageForm">
        <div class="layui-form-item">
          <button type="button" class="layui-btn" id="uploadImageBtn">
            <i class="fa fa-upload"></i> 选择图片
          </button>
          <input type="file" id="imageFile" accept="image/*" style="display: none;">
        </div>
        <div class="layui-form-item" id="previewContainer" style="display: none; text-align: center;">
          <img id="imagePreview" src="" alt="图片预览" style="max-width: 100%; max-height: 200px;">
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">图片描述</label>
          <div class="layui-input-block">
            <input type="text" id="imageDesc" placeholder="请输入图片描述（可选）" class="layui-input">
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="button" class="layui-btn" id="confirmImageBtn">插入图片</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelImageBtn">取消</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 链接插入弹窗 -->
  <div class="layui-layer layui-layer-page" id="linkInsertLayer" style="display: none; width: 500px;">
    <div class="layui-layer-title">插入链接</div>
    <div class="layui-layer-content" style="padding: 20px;">
      <form class="layui-form" lay-filter="linkForm">
        <div class="layui-form-item">
          <label class="layui-form-label">链接文本</label>
          <div class="layui-input-block">
            <input type="text" id="linkText" placeholder="请输入链接显示文本" class="layui-input" lay-verify="required">
          </div>
        </div>
        <div class="layui-form-item">
          <label class="layui-form-label">链接地址</label>
          <div class="layui-input-block">
            <input type="text" id="linkUrl" placeholder="请输入链接地址（http://或https://开头）" class="layui-input" lay-verify="required|url">
          </div>
        </div>
        <div class="layui-form-item">
          <div class="layui-input-block">
            <button type="button" class="layui-btn" id="confirmLinkBtn">插入链接</button>
            <button type="button" class="layui-btn layui-btn-primary" id="cancelLinkBtn">取消</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- 引入Layui JS -->
  <script src="https://cdn.jsdelivr.net/npm/layui-src/dist/layui.js"></script>
  <script>
    // 初始化Layui模块
    layui.use(['form', 'layer', 'element'], function() {
      var form = layui.form;
      var layer = layui.layer;
      var element = layui.element;
      
      // 自定义验证规则
      form.verify({
        titleLength: function(value) {
          if (value.length < 5) {
            return '标题至少需要5个字符';
          }
        },
        contentLength: function() {
          var text = document.getElementById('contentEditor').innerText || '';
          if (text.length < 10) {
            return '内容至少需要10个字符';
          }
        }
      });
      
      // 编辑器工具栏按钮事件
      document.querySelectorAll('.editor-toolbar button[data-command]').forEach(button => {
        button.addEventListener('click', function() {
          var command = this.getAttribute('data-command');
          document.execCommand(command, false, null);
          document.getElementById('contentEditor').focus();
          updateWordCount();
        });
      });
      
      // 字数统计更新
      function updateWordCount() {
        var text = document.getElementById('contentEditor').innerText || '';
        document.getElementById('wordCount').textContent = text.length;
      }
      
      // 监听编辑器内容变化
      document.getElementById('contentEditor').addEventListener('input', updateWordCount);
      
      // 标签添加功能
      document.getElementById('tagInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && this.value.trim() !== '') {
          e.preventDefault();
          addTag(this.value.trim());
          this.value = '';
        }
      });
      
      // 添加标签
      function addTag(tagText) {
        var tagsContainer = document.getElementById('tagsContainer');
        var tagItems = tagsContainer.querySelectorAll('.tag-item');
        
        // 检查标签数量
        if (tagItems.length >= 5) {
          layer.msg('最多只能添加5个标签', {icon: 2});
          return;
        }
        
        // 检查标签长度
        if (tagText.length > 8) {
          layer.msg('标签不能超过8个字符', {icon: 2});
          return;
        }
        
        // 检查标签是否已存在
        for (var i = 0; i < tagItems.length; i++) {
          if (tagItems[i].getAttribute('data-tag') === tagText) {
            layer.msg('该标签已存在', {icon: 2});
            return;
          }
        }
        
        // 创建新标签
        var tagElement = document.createElement('div');
        tagElement.className = 'tag-item';
        tagElement.setAttribute('data-tag', tagText);
        tagElement.innerHTML = tagText + '<span class="close"><i class="fa fa-times"></i></span>';
        
        // 添加删除事件
        tagElement.querySelector('.close').addEventListener('click', function() {
          tagsContainer.removeChild(tagElement);
        });
        
        // 插入到容器中
        tagsContainer.insertBefore(tagElement, document.getElementById('tagInput'));
      }
      
      // 图片上传相关
      document.getElementById('insertImage').addEventListener('click', function() {
        document.getElementById('contentEditor').blur();
        document.getElementById('imageUploadLayer').style.display = 'block';
        layer.open({
          type: 1,
          title: '上传图片',
          content: document.getElementById('imageUploadLayer'),
          area: ['500px', 'auto'],
          shade: 0.3,
          success: function() {
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('imageFile').value = '';
            document.getElementById('imageDesc').value = '';
          }
        });
      });
      
      document.getElementById('uploadImageBtn').addEventListener('click', function() {
        document.getElementById('imageFile').click();
      });
      
      document.getElementById('imageFile').addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('previewContainer').style.display = 'block';
          }
          reader.readAsDataURL(this.files[0]);
        }
      });
      
      document.getElementById('confirmImageBtn').addEventListener('click', function() {
        var preview = document.getElementById('imagePreview');
        if (preview.src) {
          var desc = document.getElementById('imageDesc').value || '图片';
          var imgElement = document.createElement('img');
          imgElement.src = preview.src;
          imgElement.alt = desc;
          imgElement.style.maxWidth = '100%';
          imgElement.style.margin = '10px 0';
          
          // 在编辑器中插入图片
          var selection = window.getSelection();
          if (selection.rangeCount) {
            var range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(imgElement);
            range.setStartAfter(imgElement);
            range.setEndAfter(imgElement);
            selection.removeAllRanges();
            selection.addRange(range);
          }
          
          document.getElementById('contentEditor').focus();
          updateWordCount();
          layer.closeAll();
        } else {
          layer.msg('请先选择图片', {icon: 2});
        }
      });
      
      document.getElementById('cancelImageBtn').addEventListener('click', function() {
        layer.closeAll();
      });
      
      // 链接插入相关
      document.getElementById('insertLink').addEventListener('click', function() {
        document.getElementById('contentEditor').blur();
        layer.open({
          type: 1,
          title: '插入链接',
          content: document.getElementById('linkInsertLayer'),
          area: ['500px', 'auto'],
          shade: 0.3,
          success: function() {
            document.getElementById('linkText').value = '';
            document.getElementById('linkUrl').value = '';
            
            // 尝试获取选中的文本作为链接文本
            var selection = window.getSelection();
            if (selection.toString()) {
              document.getElementById('linkText').value = selection.toString();
            }
          }
        });
      });
      
      document.getElementById('confirmLinkBtn').addEventListener('click', function() {
        var text = document.getElementById('linkText').value.trim();
        var url = document.getElementById('linkUrl').value.trim();
        
        if (!text) {
          layer.msg('请输入链接文本', {icon: 2});
          return;
        }
        
        if (!url) {
          layer.msg('请输入链接地址', {icon: 2});
          return;
        }
        
        // 验证URL格式
        var urlPattern = /^(http|https):\/\/[^ "]+$/;
        if (!urlPattern.test(url)) {
          layer.msg('请输入有效的链接地址（http://或https://开头）', {icon: 2});
          return;
        }
        
        // 创建链接元素
        var linkElement = document.createElement('a');
        linkElement.href = url;
        linkElement.target = '_blank';
        linkElement.textContent = text;
        
        // 在编辑器中插入链接
        var selection = window.getSelection();
        if (selection.rangeCount) {
          var range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(linkElement);
          range.setStartAfter(linkElement);
          range.setEndAfter(linkElement);
          selection.removeAllRanges();
          selection.addRange(range);
        }
        
        document.getElementById('contentEditor').focus();
        updateWordCount();
        layer.closeAll();
      });
      
      document.getElementById('cancelLinkBtn').addEventListener('click', function() {
        layer.closeAll();
      });
      
      // 预览按钮
      document.getElementById('previewBtn').addEventListener('click', function() {
        var title = document.getElementById('title').value;
        var content = document.getElementById('contentEditor').innerHTML;
        
        if (!title || !content) {
          layer.msg('请填写标题和内容后再预览', {icon: 2});
          return;
        }
        
        var previewHtml = `
          <div style="padding: 20px;">
            <h2 style="margin-bottom: 15px;">${title}</h2>
            <div style="border-top: 1px solid #e6e6e6; padding-top: 15px;">
              ${content}
            </div>
          </div>
        `;
        
        layer.open({
          type: 1,
          title: '帖子预览',
          content: previewHtml,
          area: ['80%', '80%'],
          shade: 0.3
        });
      });
      
      // 保存草稿按钮
      document.getElementById('saveDraftBtn').addEventListener('click', function() {
        var title = document.getElementById('title').value;
        var content = document.getElementById('contentEditor').innerHTML;
        
        if (!title && !content) {
          layer.msg('标题和内容都为空，无需保存', {icon: 2});
          return;
        }
        
        // 收集标签
        var tags = [];
        document.querySelectorAll('.tag-item').forEach(tag => {
          tags.push(tag.getAttribute('data-tag'));
        });
        
        // 收集表单数据
        var draftData = {
          title: title,
          category: form.val('postForm').category,
          content: content,
          tags: tags,
          visibility: form.val('postForm').visibility,
          saveTime: new Date().toISOString()
        };
        
        // 保存到localStorage
        localStorage.setItem('postDraft', JSON.stringify(draftData));
        
        layer.msg('草稿保存成功', {icon: 1});
      });
      
      // 尝试加载草稿
      window.addEventListener('load', function() {
        var draft = localStorage.getItem('postDraft');
        if (draft) {
          draft = JSON.parse(draft);
          
          // 询问用户是否加载草稿
          layer.confirm(`检测到上次未完成的草稿（保存于${new Date(draft.saveTime).toLocaleString()}），是否加载？`, {
            btn: ['加载草稿', '不加载']
          }, function() {
            // 加载草稿数据
            document.getElementById('title').value = draft.title || '';
            document.getElementById('contentEditor').innerHTML = draft.content || '';
            form.val('postForm', {
              'category': draft.category || '',
              'visibility': draft.visibility || 'public'
            });
            
            // 加载标签
            if (draft.tags && draft.tags.length) {
              draft.tags.forEach(tagText => {
                addTag(tagText);
              });
            }
            
            form.render();
            updateWordCount();
            layer.msg('草稿已加载', {icon: 1});
          });
        }
      });
      
      // 提交表单
      form.on('submit(postSubmit)', function(data) {
        // 收集标签
        var tags = [];
        document.querySelectorAll('.tag-item').forEach(tag => {
          tags.push(tag.getAttribute('data-tag'));
        });
        
        // 构建完整的帖子数据
        var postData = {
          title: data.field.title,
          category: data.field.category,
          content: document.getElementById('contentEditor').innerHTML,
          tags: tags,
          visibility: data.field.visibility,
          createTime: new Date().toISOString()
        };
        
        // 在实际应用中，这里会发送到服务器
        console.log('发布的帖子数据:', postData);
        
        // 模拟提交成功
        layer.confirm('帖子发布成功！是否返回首页？', {
          btn: ['返回首页', '继续发布']
        }, function() {
          // 清除草稿
          localStorage.removeItem('postDraft');
          // 实际应用中会跳转到首页
          layer.msg('正在返回首页...', {icon: 1});
        }, function() {
          // 清除表单
          document.getElementById('title').value = '';
          document.getElementById('contentEditor').innerHTML = '';
          document.querySelectorAll('.tag-item').forEach(tag => {
            tag.remove();
          });
          form.val('postForm', {
            'category': '',
            'visibility': 'public'
          });
          form.render();
          updateWordCount();
          layer.closeAll();
        });
        
        return false; // 阻止表单跳转
      });
    });
  </script>
</body>
</html>
